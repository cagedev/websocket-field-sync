<!DOCTYPE html>

<head>
  <style type="text/css">
    * {
      box-sizing: border-box;
      font-family: sans-serif;
      font-size: small;
      margin: 2px;
    }

    body {
      margin: 20px;
      background-color: #fafafa;
    }
  </style>
</head>

<body>
  <form id="wfs-config">

    <label for="serverUrl">serverUrl</label>
    <input type="text" id="serverUrl" name="serverUrl" value="ws://127.0.0.1:8080">
    <br />

    <label for="token">token</label>
    <select type="text" id="token" name="token" value="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJPbmxpbmUgSldUIEJ1aWxkZXIiLCJpYXQiOjE2NTEyNDA1NjIsImV4cCI6MTY4Mjc3NjY1NiwiYXVkIjoid3d3LmV4YW1wbGUuY29tIiwic3ViIjoianJvY2tldEBleGFtcGxlLmNvbSIsInVzZXJJZCI6ImQzN2JlNmE4LWM0M2YtNDhjZS1iZWMxLWExODEyNmUwNWQ2MCJ9.Lgk7uVRNeR89kOIYR5aT6gVaOfj1BtSqCSzlyLKCkO8">
    <option value="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJPbmxpbmUgSldUIEJ1aWxkZXIiLCJpYXQiOjE2NTEyNDA1NjIsImV4cCI6MTY4Mjc3NjY1NiwiYXVkIjoid3d3LmV4YW1wbGUuY29tIiwic3ViIjoianJvY2tldEBleGFtcGxlLmNvbSIsInVzZXJJZCI6ImQzN2JlNmE4LWM0M2YtNDhjZS1iZWMxLWExODEyNmUwNWQ2MCJ9.Lgk7uVRNeR89kOIYR5aT6gVaOfj1BtSqCSzlyLKCkO8">value 0 (valid)</option>
    <option value="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJPbmxpbmUgSldUIEJ1aWxkZXIiLCJpYXQiOjE2NTEzMDY5MjUsImV4cCI6MTY4Mjg0MjkyNywiYXVkIjoid3d3LmV4YW1wbGUuY29tIiwic3ViIjoianJvY2tldEBleGFtcGxlLmNvbSIsInVzZXJJZCI6ImUzMTBlMzNkLWUxNzItNDY0NC1iNmUwLWFlZWM3NDljMTFlYyJ9.bX0mp4rmSOut60t8TMJQlVQXWrVWCvxjGKTrAPynkEg">value 1 (valid)</option>
    <option value="dyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJPbmxpbmUgSldUIEJ1aWxkZXIiLCJpYXQiOjE2NTEzMDY5MjUsImV4cCI6MTY4Mjg0MjkyNywiYXVkIjoid3d3LmV4YW1wbGUuY29tIiwic3ViIjoianJvY2tldEBleGFtcGxlLmNvbSIsInVzZXJJZCI6ImUzMTBlMzNkLWUxNzItNDY0NC1iNmUwLWFlZWM3NDljMTFlYyJ9.bX0mp4rmSOut60t8TMJQlVQXWrVWCvxjGKTrAPynkEg">value 2 (invalid)</option>
    </select>
    <br />

    <label for="userName">userName</label>
    <input type="text" id="userName" name="userName" value="Test User">
    <br />

    <label for="userId">userId</label>
    <input type="text" id="userId" name="userId" value="00000000-0000-0000-0000-000000000000" />
    <br />

    <label for="roomId">roomId</label>
    <input type="text" id="roomId" name="roomId" value="default" />
    <br />

    <label for="dataElementId">dataElementId</label>
    <input type="text" id="dataElementId" name="dataElementId" value="targetField" />
    <br />

    <label for="updateEvent">updateEvent</label>
    <input type="text" id="updateEvent" name="updateEvent" value="onchange" />
    <br />

    <label for="eventElementId">eventElementId</label>
    <input type="text" id="eventElementId" name="eventElementId" value="targetField" />
    <br />

    <label for="syncType">syncType</label>
    <input type="text" id="syncType" name="syncType" value="SEND" />
    <br />

    <button type="submit">configure</button>
  </form>

  <form id="wfs-data">
    <textarea id="targetField" name="targetField">This is the target field.</textarea>
    <br />

    <textarea id="targetField2" name="targetField2">This is targetField2.</textarea>
    <br />

    <button type="submit" id="wfs-connect">connect</button>
    <button type="button" id="wfs-send">send</button>
  </form>
</body>

<script>
  var wfsConnection = null;
  var wfsConfig = {}
  var wfsData = {
    userName: '',
    userId: '',
    roomId: '',
    syncType: '',
  }


  function updateWfsData() {
    // Hacky because no two way sync
    // This should include the connections as an array

    // Update relevant part of wfsData from wfsConfig
    wfsData.roomId = wfsConfig.roomId;
    wfsData.syncType = wfsConfig.syncType;
    wfsData.userId = wfsConfig.userId;
    wfsData.userName = wfsConfig.userName;
  }


  // Event handlers
  // => handleConfigureButton?
  function handleConfigureButton(event) {
    event.preventDefault();
    const formdata = new FormData(event.target);
    wfsConfig = Object.fromEntries(formdata.entries());

    // DEBUG
    console.log('wfsConfig', wfsConfig);

    // Set event handler
    let evt = wfsConfig.updateEvent;
    let id = wfsConfig.eventElementId;
    document.getElementById(id).addEventListener(evt, function (event) {
      console.log(event);
      updateWfsData();
      wfsConnection.send(JSON.stringify({
        event: "DATA_MESSAGE",
        wfsData: wfsData,
        payload: {
          messageData: document.getElementById(id).value,
        }
      }));
    })
  }

  // => handleConnectButtonButton?
  function handleConnectButton(event) {
    event.preventDefault();
    wfsConnection = new WebSocket(`${wfsConfig.serverUrl}?token=${wfsConfig.token}`, "json");

    wfsConnection.onopen = function (event) {

      // DEBUG
      console.log("wfsConnection.onopen");

      // TODO request connectionId
      // TODO define datastructure

      // OLD TODO new login procedure
      // updateWfsData();
      // wfsConnection.send(JSON.stringify({
      //   event: "SERVER_REQUEST",
      //   wfsData: wfsData,
      //   payload: {
      //     requestedData: "USER_ID",
      //   }
      // }));

      // TODO start statusMonitor
      //  - timeSinceLastMessage
      //  - connectionSpeed
    };

    wfsConnection.onmessage = function (event) {
      // DEBUG
      let msg = JSON.parse(event.data);

      console.log("wfsConnection.onmessage");

      // Interpret message
      // Assume event/payload-structure
      // Use a connection structure
      switch (msg.event) {

        case "MESSAGE":
          console.log("MESSAGE:", msg.payload);
          break;

        case "RESPONSE":
          console.log("RESPONSE:", msg.payload);

          if (msg.payload.var == "USER_ID") {
            wfsConfig.userId = msg.payload.value;
            document.getElementById("userId").value = wfsConfig.userId;
            updateWfsData();
            wfsConnection.send(JSON.stringify({
              event: "SERVER_REQUEST",
              wfsData: wfsData,
              payload: {
                requestedData: "ROOM_ID",
              }
            }));
          }

          else if (msg.payload.var == "ROOM_ID") {
            wfsConfig.roomId = msg.payload.value;
            document.getElementById("roomId").value = wfsConfig.roomId;
          }

          else {
            console.log("Error: Invalid RESPONSE payload", msg.payload);
          }
          break;

        case "UPDATE":
          console.log("UPDATE:", msg.payload);
          wfsConfig.state = msg.payload.state;
          // DEBUG
          console.log("wfsConfig:", wfsConfig);
          break;

        default:
          console.log("Unrecognised message:", msg);
      }

    };

    wfsConnection.onclose = function (event) {
      console.log('Connection closed.')
    };

    // TODO
    // setup wfs-link with current parameters
    // ? auth on serverUrl
    // - connect to serverUrl
    // - send setup message
    // - set local data event handler
    //   - on event
    //   - update data package
    //   - send data
    // - set external event handler
    //   - on message
    //   - update local data package
    //   - update local data field (do not fire handler)
  };

  function handleSendButton(event) {
    // TODO use prototype 
    updateWfsData();
    let msg = {
      event: "DATA_MESSAGE",
      wfsData: wfsData,
      payload: {
        updateType: "FULL", // {FULL, UPDATE/DIFF}
        messageData: document.getElementById(wfsConfig.dataElementId).value,
      }
    }
    console.log('handleSendButton', msg);
    wfsConnection.send(JSON.stringify(msg));
  }

  // Set up event handlers
  document.getElementById('wfs-config').addEventListener('submit', handleConfigureButton);
  document.getElementById('wfs-data').addEventListener('submit', handleConnectButton);
  document.getElementById('wfs-send').addEventListener('click', handleSendButton);
</script>

</html>